defaults
  mode tcp
  timeout client 10s
  timeout connect 5s
  timeout server 10s
  timeout http-request 10s
  log /dev/log local0 info
  log global
  option tcplog
  # mode http
  # option httplog
  # option logasap

frontend http
  mode http
  bind :8000

  acl is_letsencrypt path_beg /.well-known/acme-challenge/
  redirect scheme https if !is_letsencrypt

  default_backend letsencrypt

frontend https
  bind :4430

  tcp-request inspect-delay 5s
  tcp-request content accept if { req_ssl_hello_type 1 }

  acl is_k8s_passthrough req.ssl_sni -i {{ k8s_passthrough_domains | join(' ') }}
  use_backend k8s_passthrough if is_k8s_passthrough

  default_backend https_terminated

frontend https_terminated
  bind :4433 ssl crt /etc/haproxy/certs
  # same as before but adds ssl_fc_sni. can remove if no longer needed.
  log-format "%ci:%cp %ft %b/%s %Tw/%Tc/%Tt %B %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq ssl_fc_sni=%[ssl_fc_sni]"

  # no listening domains atm

backend https_terminated
  server self 127.0.0.1:4433

backend k8s_passthrough
  server self 127.0.0.1:443

backend letsencrypt
  mode http
  server self localhost:9999
